extends ./layout/layout_main.pug

block css
  style.

  //- style


block content


  section.productdetails(ng-app="myApp" ng-controller="myCtrl" ng-cloak)
    .container
      p.bread(ng-repeat="breadcrumbs in product0.breadcrumbs")
        span(ng-repeat="crumb in breadcrumbs.breadcrumbs")
          a( href='drinks.html?category={{crumb.categoryId}}', data-toggle='modal') {{crumb.name}}
          | &nbsp;/&nbsp;
        span
          a(href='#', data-toggle='modal')
            strong {{variant0.name}}
          //- a
      //- p
      //- bread
      .row
        .col-md-5.text-center
          h1
            span {{variant.manufacturer}}
            br
            strong
              small {{variant.name}}
            //- strong
            br
            p
            .row.pdetail-info-text
              .col-md-6.text-left
                small
                  | RRP {{pricingInfo.rrp}}&nbsp;
                  span.pb / bottle
                //- small
              //- col-md-6
              .col-md-6.text-right
                small
                  span.avl {{variant.quantity}} available / 319 sold
                //- small
              //- col-md-6
            //- row
          //- h1
          hr
          .stage.infos
            a.button.inline.v8.absolute._left.see-all-drinks.thin-line(href="shop.html") see all drinks
            .stats
              .rate-counter
                .ring
                  .count
                    div(id="product_rating") 94
                    span points
                //- ring
              //- rate-counter
            //- stats
            img(ng-src="{{variant0_image}}", alt="")
          //- stage
          br
          p
        //- col-md-5
        .col-md-7.product-detail-wrap
          .infos
            .row
              .col-md-12
                .inventory
                  .pricing
                    .prod-details.deals
                      .label-qty.cols
                        strong Qty
                        br
                      //- qty
                      .label-bottle.cols
                        strong Bottle
                        br
                      //- label-bottle
                      .label-pack.cols
                        strong {{pricingInfo.packSize}} Pack
                        br
                        //- span
                      //- price
                      .label-savings.cols
                        span
                          strong.green Save
                        br
                        small.green (per pack)
                      //- savings
                      .more-actions.cols
                    //- prod-details

                    hr
                    div(ng-repeat="price in pricingInfo.priceTable")
                      .prod-details.deals
                        .label-qty.cols
                          span(style="{{price.style1}}") {{price.label}}
                        //- qty
                        .label-bottle.cols
                          span(style="{{price.style2}}") {{price.unitPrice}}
                        //- label-bottle
                        .label-pack.cols
                          span(style="{{price.style2}}") {{price.packPrice}}
                          //- span
                        //- price
                        .label-savings.cols
                          strong(ng-if="price.showBuy")
                            big.lead {{price.save}}
                          span(ng-if="!price.showBuy" style="{{price.style1}}") {{price.save}}
                        //- savings
                        .more-actions.cols
                          a.button.inline.v8.buynow.thin-line(ng-if="price.showBuy" href="#", target="_blank")
                            span.num buy now
                          //- a
                          a.button.inline.v7.thin-line(ng-if="price.showSharedBuy" href='circlebuy-join.html') join a circlebuy
                          a.button.inline.v8.thin-line(ng-if="price.showSharedBuy" href='circlebuy-start.html?product={{variant0.productVariantId}}') create a circlebuy *
                        //- more-actions
                      //- prod-details
                    //- div

                    br
                    p.text-center.relative.font12 * creator bonus: extra 50% off first case
                      a.green.absolute._right(href="circlebuys.html") learn about circlebuying
                    //- p
                  //- pricing
                //- inventory
              //- col-md-12
            //- row
            hr
            .row
              .col-md-4
                //- p.lead.text-center.totalcbcount Duration: 72hrs
              //- col-md-4
              .col-md-4
                p.lead.text-center.totalcbcount {{sharedOrders_num}} circlebuys to join
              //- col-md-4
              .col-md-4
                //- .text-right
                //-   a.button.inline.v7(href="#") public
                //-   | &nbsp;
                //-   a.button.inline.v7(href="#") friends
                //- //- text-right
              //- col-md-4
            //- row


            //
            // Circle Buys short list, initially displayed
            //
            .row

              div(ng-repeat="sharedOrder in sharedOrders_shortList").col-md-6.col-sm-6.text-center.super-customized
                circlebuy-widget

            //- row
            br


            // Circle Buys long list, initially hidden
            .expand.text-center
              a(href='#initiallyHiddenCircleBuys', data-toggle='collapse')
                | more&nbsp;
                i.fa.fa-caret-down
            //- expand
            .row(id="initiallyHiddenCircleBuys" class="collapse")
              div(ng-repeat="sharedOrder in sharedOrders_longList").col-md-6.col-sm-6.text-center.super-customized
                br
                circlebuy-widget
            //- row


            // Product Details / Tasting Notes / Winery Information
            hr
            .about
              .tabs
                ul.nav.nav-tabs(role='tablist')
                  li.active(role='presentation')
                    a(href='#pDetails', role='tab', data-toggle='tab') Product Details
                  //- li
                  li(role='presentation')
                    a(href='#pTastingNotes', role='tab', data-toggle='tab') Tasting Notes
                  //- li
                  li(role='presentation')
                    a(href='#pWineryInfo', role='tab', data-toggle='tab') Winery Information
                  //- li
                //- ul
                .tab-content.card
                  #pDetails.tab-pane.active(role='tabpanel')
                    p.comment
                      strong Brokenwood Graveyard Vineyard Shiraz&nbsp;
                      | is a ripe and generous shiraz with lifted cherry and mint aromas nicely balanced with sweet chocolate notes on the nose and a soft rich palate with savoury cedary flavours and fine grained tannins on the finish.
                    //- p
                    .row
                      .col-xs-4.col-md-4
                        p
                          strong.green variety
                          br
                          | Shiraz
                        //- p
                      //- col-md-4
                      .col-xs-4.col-md-4
                        p
                          strong.green region
                          br
                          | Hunter Valley
                        //- p
                      //- col-md-4
                      .col-xs-4.col-md-4
                        p
                          strong.green alcohol
                          br
                          | 14.5%
                        //- p
                      //- col-md-4
                      .col-xs-4.col-md-4
                        p
                          strong.green vintage
                          br
                          | 2010
                        //- p
                      //- col-md-4
                      .col-xs-4.col-md-4
                        p
                          strong.green shipping
                          br
                          | Free
                        //- p
                      //- col-md-4
                      .col-xs-4.col-md-4(data-expand-items)
                        p
                          strong.green returns
                          br
                          | 60 days
                        //- p
                      //- col-md-4
                      .col-xs-4.col-md-4(data-expand-items)
                        p
                          strong.green case size
                          br
                          | 12 bottles
                        //- p
                      //- col-md-4
                      .col-xs-4.col-md-4(data-expand-items)
                        p
                          strong.green standard drinks
                          br
                          | 8
                        //- p
                      //- col-md-4
                      .col-xs-4.col-md-4(data-expand-items)
                        p
                          strong.green food matching
                          br
                          | Osso Bucco, Lamb
                        //- p
                      //- col-md-4
                      .col-xs-4.col-md-4
                        p.share
                          strong.green share
                            br
                            a(href="#", target="_blank")
                              i.fa.fa-twitter
                            //- a
                            a(href="#", target="_blank")
                              i.fa.fa-facebook
                            //- a
                            a(href="#", target="_blank")
                              i.fa.fa-google-plus
                            //- a
                            a(href="#", target="_blank")
                              i.fa.fa-envelope
                            //- a
                        //- p.share
                      //- col-md-4
                    //- row
                    .expand.text-center
                      a(href='#', data-expand)
                        span.text more
                        span.text(style='display: none') less
                        | &nbsp;
                        i.fa.fa-caret-down
                      //- a
                    //- expand
                  //- tab-pane
                  #pTastingNotes.tab-pane(role='tabpanel')

                  //- tab-pane
                  #pWineryInfo.tab-pane(role='tabpanel')

                  //- tab-pane
                //- tab-content
              //- tabs
            //- about

          // Reviews Section
          review-widget
<<<<<<< HEAD

            //- // Discussions
            //- p.lead Discussions
            //- .list_groups.discussions
            //-   .content
            //-     .commentbox
            //-       .input-group
            //-         span.input-group-addon
            //-           .thumb
            //-             .img
            //-               img(src='assets/images/anonymous.png', alt='')
            //-             //- img
            //-           //- thumb
            //-         //- span
            //-         span.form-control
            //-           .composer
            //-             .head
            //-               a(href='#modal_coming_soon', data-toggle='modal')
            //-                 i.fa.fa-pencil
            //-                 | Status
            //-               //- a
            //-               a(href='#modal_coming_soon', data-toggle='modal')
            //-                 i.fa.fa-picture-o
            //-                 | Photo/Video
            //-               //- a
            //-               a(href='#modal_coming_soon', data-toggle='modal')
            //-                 i.fa.fa-calendar-o
            //-                 | Event
            //-               //- a
            //-             //- head
            //-             .content
            //-               textarea.form-control(rows='4')
            //-             //- content
            //-             .controls
            //-               a(href='#modal_coming_soon', data-toggle='modal')
            //-                 i.fa.fa-camera
            //-               //- a
            //-               a(href='#modal_coming_soon', data-toggle='modal')
            //-                 i.fa.fa-user-plus
            //-               //- a
            //-               a(href='#modal_coming_soon', data-toggle='modal')
            //-                 i.fa.fa-smile-o
            //-               //- a
            //-               a(href='#modal_coming_soon', data-toggle='modal')
            //-                 i.fa.fa-map-marker
            //-               //- a
            //-               a(href='#modal_coming_soon', data-toggle='modal')
            //-                 i.fa.fa-clock-o
            //-               //- a
            //-               a.post(href='#')
            //-                 i.fa.fa-send-o
            //-                 | Post
            //-               //- a
            //-             //- controls
            //-           //- composer
            //-         //- span
            //-       //- input-group
            //-     //- commentbox

            //-     .input-group.discussion-row
            //-       span.input-group-addon
            //-         .thumb
            //-           .img
            //-             img(src='assets/images/users/user_1.jpg', alt='')
            //-       span.form-control
            //-         small
            //-           | by
            //-           a(href="profile") Andrew Steer
            //-           | | May 25, 2016
            //-         //- small
            //-         p.comment Hi! has anybody tried this with waygu steak with asparagus saute potatoes?
            //-       //- span
            //-       .generic-controls
            //-         a(href='#modal_coming_soon', data-toggle='modal')
            //-           i.fa.fa-heart
            //-           | Like
            //-         a(href='#modal_coming_soon', data-toggle='modal')
            //-           i.fa.fa-comment
            //-           | Comment
            //-       //- generic-controls
            //-     //- input-group
            //-     .input-group.discussion-row
            //-       span.input-group-addon
            //-         .thumb
            //-           .img
            //-             img(src='assets/images/users/user_2.jpg', alt='')
            //-       span.form-control
            //-         small
            //-           | by
            //-           a(href='#modal_coming_soon', data-toggle='modal') Carter Smith
            //-           | | May 26, 2016
            //-         //- small
            //-         p.comment I had it with char grill ribeye fillet medium rare and i finished the whole bottle :)
            //-       //- span
            //-       .generic-controls
            //-         a(href='#modal_coming_soon', data-toggle='modal')
            //-           i.fa.fa-heart
            //-           | Like
            //-         a(href='#modal_coming_soon', data-toggle='modal')
            //-           i.fa.fa-comment
            //-           | Comment
            //-       //- generic-controls
            //-     //- input-group
            //-   //- content
            //- //- list_groups
=======
            
>>>>>>> philChristmas
          //- infos
        //- col-md-7
      //- row
    //- container
  //- section

block scripts
  // External Script goes here...
  script(src='assets/vendor/crowdhound/chratingsandreview.js', type="text/javascript")
  script.
    $(document).ready(function(){
<<<<<<< HEAD
     // crowdhoundservice.init();
      //- $(window).on("load resize", function() {
      //-   if ( $(this).width() > 991 ) {
      //-     $('section.productdetails').outerHeight(function(){
      //-       var top = $('nav.navbar').outerHeight();
      //-       var bottom = $('footer').outerHeight(true);
      //-       var screenHeight = $(window.top).height();
      //-
      //-       return (screenHeight - (top + bottom));
      //-     });
      //-     $('.product-detail-wrap, .productdetails .stage').height(function() {
      //-       return $('section.productdetails').height() - $('.bread').outerHeight();
      //-     });
      //-   } else {
      //-     $('section.productdetails, .product-detail-wrap, .productdetails .stage').height("");
      //-   }
      //- });
      /*setTimeout(function() {

        $('.popover_rating[data-toggle="popover"]').popover({
          html: true,
          content : function() {
            console.log($(this).parent().find("span.ratings").html())
            return '<span class="ratings">' + $(this).parent().find("span.ratings").html() + '</span>';
          },
          title: function(){
            return jQuery(this).data('title') + '<span class="close">&times;</span>';
          }
        }).on('shown.bs.popover', function(e) {
          var popover = jQuery(this);
          $(this).parent().find('.popover span.close').on('click', function(e) {
            popover.popover('hide');
          });
        }).click(function(e) {
          e.preventDefault();
        });
      },500);*/

=======
     
>>>>>>> philChristmas
    });


    /************************************************************
     *
     *    Angular code.
     */
    var app = angular.module('myApp', ['ngSanitize']);

    teaservice.init(app);

    // Add the controller for this page
    app.controller('myCtrl', function($scope, teaService) {

      // This code gets the "product" parameter from the
      // URL so we can use it as productVariantId.
      var productVariantId = NaN;
      window.location.search.replace(/[?&]+([^=&]+)=([^&]*)/gi, function(str, key, value) {
        if (key === 'product') {
          productVariantId = parseInt(value);
        }
      });
      //console.log('Displaying the page for productVariantId=' + productVariantId);

      // During development only
      var DEFAULT_PRODUCT_VARIANT_ID = 6180;
      if (isNaN(productVariantId)) {
        productVariantId = DEFAULT_PRODUCT_VARIANT_ID;
      }


      // Start updating countdownTimers, even though
      // we won't have any yet.
      teaService.startCountdownTimers();


      // Call the TEA API to get the product details
      var params = {
        productVariantId: productVariantId,
        needPricing: true,
        needImages: true,
        needBreadcrumbs: true
      };
      teaService.getProduct(params).then(function(products){

        // Display the product details
        console.log('\n\n\nREPLY FROM getProduct:', products);
        if (products && products.length > 0 && products[0].variants.length > 0) {

          // In Drinkcircle there is one-to-one between products and variants.
          $scope.productVariantId = productVariantId;
          $scope.product0 = products[0];
          $scope.variant0 = products[0].variants[0];

          // See if we have an image for this product variant
          if ($scope.variant0.images && $scope.variant0.images.length > 0) {
            $scope.variant0_image = $scope.variant0.images[0].imagePath;
          } else {
            $scope.variant0_image = 'NOTFOUND.jpg'; // ZZZZZ
          }

          // Set the pricing information.
          $scope.pricingInfo = teaService.calculatePriceTable($scope.variant0);
        } else {
          //ZZZ Redirect to an error page or something.
          alert('unknown product variant ' + productVariantId);
        }
      });


      // Display the circle buys
      teaService.getSharedOrdersAndSetAngularVariables({
        productVariantId: productVariantId
      }, $scope, teaService,function(){
          
            setTimeout(function(){
            console.log("asdasfas");
            Main.circlebuyGaugeInit();
            },3000);
        });

      /*
       *  See if the user is logged in
       */
      authservice.init({
        // Environment specific values are defined in environment.js
        host: AUTHSERVICE_HOST,
        port: AUTHSERVICE_PORT,
        tenant: AUTHSERVICE_TENANT,
        pretend: AUTHSERVICE_USE_DUMMY_LOGIN,
        onUserChange: function(user, ttuat, fromCookie) {
          // If the current user came from the cookie, reload it
          //if (fromCookie) {
          //  console.log('Reloading user details (cookie details are just a summary)');
          //  return authservice.reloadUser();
          //}
          if (user) {
            $scope.loggedIn = true;
          } else {
            $scope.loggedIn = false;
          }



          /*
           *  Now initialize CrowdHound
           */
          crowdhoundConfig = {
                serverUrl : '//' + CROWDHOUND_HOST + ':' + CROWDHOUND_PORT,
                apiVersion : CROWDHOUND_VERSION,
                tenantId : CROWDHOUND_TENANT,
                debug: false,
                //authenticationToken : authservice.getUserAccessToken(),
                authenticationToken: authservice.getUserAccessToken(),
                urlive : false,
                flat: false,
                textonly: false,
                cookers: {
                    //cook_avatars : cookAvatars, //definition is in the curia_js widget
                    cook_ratings: chratingsandreview.cookRatings
                },
                themes : {
                    "productReview": {
                        "product-reviews_0" : "#reviewList",
                        "review_0" : "#review"
                    }
                }

                // cookers: {
                    //cook_avatars : cookAvatars, //definition is in the curia_js widget
                    //cook_ratings : ProductReview.cookRatings
                //},
                //themes : {
          //"productReview": {
            //"product-reviews_0" : "#reviewList",
                        //"review_0" : "#review",
                        //"options":  { flat: false, textonly: true, readonly: false },
                  //}

                //}
          };
          console.log('about to initialise Crowdhound:', crowdhoundConfig)
          CrowdHound.init(crowdhoundConfig, function afterCuriaInit() {

            // Load the reviews
            chratingsandreview.loadReview()

          }); // CrowdHound.init
        }
      });
    });// app.controller('myApp')


    /*
     *  Set up the login part at the top of the page.
     */


  //- script.
//- block scripts
